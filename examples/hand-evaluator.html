<style>
	body {
		background-color: green;
		margin: 0px;
		user-select: none;
		font-family: arial;
	}
</style>
<link rel="stylesheet" href="css/card-ui.css" />

<body>
	<h2>Hand name <span id='myHandNameID'>?</span></h2>
	<h2>oddsIfAllInValue: <span id='oddsIfAllInValueID'>?</span></h2>
	<h2>oddsIfAllInRounds: <span id='oddsIfAllInRoundsID'>?</span></h2>
	<h2>Outs: count <span id='nOutsID'>?</span> - cards <span id='OutCardsID'>?</span></h2>
	<div>requiredHandRank
		<select id="outsRequiredHandRankID"></select>
	</div>
	<h2>Community Cards</h2>
	<div id='communityCardsID'></div>
	<h2>Hole Cards</h2>
	<div id='holeCardsID'></div>
	<h2>Parameters</h2>
	<label>
		n other players:
		<input type="number" id="nOtherPlayersID" min='2' max='22' value='2'>
	</label>


	<!-- html for card selection -->
	<div id='cardSelectionID' style='display: none'>
		<div class='denominationSelection'>
			<div data-card-denomination='2'>2</div>
			<div data-card-denomination='3'>3</div>
			<div data-card-denomination='4'>4</div>
			<div data-card-denomination='5'>5</div>
			<div data-card-denomination='6'>6</div>
			<div data-card-denomination='7'>7</div>
			<div data-card-denomination='8'>8</div>
			<div data-card-denomination='9'>9</div>
			<div data-card-denomination='T'>10</div>
			<div data-card-denomination='J'>J</div>
			<div data-card-denomination='Q'>Q</div>
			<div data-card-denomination='K'>K</div>
			<div data-card-denomination='A'>A</div>
			<div data-card-denomination=' '>&nbsp;</div>
		</div>
		<div class='suitSelection'>
			<div data-card-suit='s'>♠</div>
			<div data-card-suit='h' style='color:red'>♥</div>
			<div data-card-suit='c'>♣</div>
			<div data-card-suit='d' style='color:red'>♦</div>
		</div>
	</div>

</body>
<script type='module'>
	import PokerHand from '../src/index.js'

	window.PokerHand = PokerHand;

	['  ', '  ', '  ', '  ', '  '].forEach((cardValue) => {
		var cardDomElement = PokerHand.CardDomElement.create(cardValue)
		document.querySelector('#communityCardsID').appendChild(cardDomElement)
		cardDomElement.addEventListener('click', function () {
			PokerHand.CardUISelection.modal(cardDomElement.dataset.cardValue, function (newCardSelected) {
				cardDomElement.dataset.cardValue = newCardSelected
				console.log('newCardSelected', newCardSelected)
				PokerHand.CardDomElement.update(cardDomElement)
				onHandChange()
			})
		})
	});
	['  ', '  '].forEach((cardValue) => {
		var cardDomElement = PokerHand.CardDomElement.create(cardValue)
		document.querySelector('#holeCardsID').appendChild(cardDomElement)
		cardDomElement.addEventListener('click', function () {
			PokerHand.CardUISelection.modal(cardDomElement.dataset.cardValue, function (newCardSelected) {
				cardDomElement.dataset.cardValue = newCardSelected
				console.log('newCardSelected', newCardSelected)
				PokerHand.CardDomElement.update(cardDomElement)
				onHandChange()
			})
		})
	})

	document.querySelector('#nOtherPlayersID').addEventListener('change', function () {
		onHandChange()
	})

	////////////////////////////////////////////////////////////////////////
	//		Code
	////////////////////////////////////////////////////////////////////////

	function onHandChange() {
		resetOddsIfAllIn()
		displayOddsIfAllIn()
		displayOuts()
		displayMyHandName()
	}

	function displayMyHandName(){
		// get holdCards + communityCards from UI
		let holeCards = Array.from(document.querySelectorAll('#holeCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)
		let communityCards = Array.from(document.querySelectorAll('#communityCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)

		// create myHand
		let cardsPool = holeCards.concat(communityCards)
		let myHand = PokerHand.Hand.make(cardsPool)

		// update UI
		document.querySelector('#myHandNameID').innerHTML = myHand.handName
	}

	////////////////////////////////////////////////////////////////////////
	//		Handle Outs
	////////////////////////////////////////////////////////////////////////

	// init #outsRequiredHandRankID
	(function initOutsRequiredHandRankID() {
		// add 'Better Hand' special case - with a value of -1
		let htmlContent = `<option value='-1'>Better Hand</option>`
		let domElement = createElementFromHTML(htmlContent)
		document.querySelector('#outsRequiredHandRankID').appendChild(domElement)

		// add options for each HandRanks
		Object.keys(PokerHand.Hand.HandEvaluator.HandRanks).reverse().forEach((handName) => {
			let handRank = PokerHand.Hand.HandEvaluator.HandRanks[handName]
			let htmlContent = `<option value='${handRank}'>${handName}</option>`
			let domElement = createElementFromHTML(htmlContent)
			document.querySelector('#outsRequiredHandRankID').appendChild(domElement)
		})

		// select 'Better Hand' at first
		document.querySelector('#outsRequiredHandRankID').value = -1
		return

		function createElementFromHTML(HtmlContent) {
			var div = document.createElement('div');
			div.innerHTML = HtmlContent.trim();
			return div.firstChild;
		}
	})()

	// update displayOuts on #outsRequiredHandRankID change
	document.querySelector('#outsRequiredHandRankID').addEventListener('change', function () {
		displayOuts()
	})


	function displayOuts() {
		document.querySelector('#nOutsID').innerHTML = '?'
		document.querySelector('#OutCardsID').innerHTML = '?'

		// get holdCards + communityCards from UI
		let holeCards = Array.from(document.querySelectorAll('#holeCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)
		let communityCards = Array.from(document.querySelectorAll('#communityCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)

		// if less than 2 holdCards are defined, return now
		if (holeCards.length < 2) return


		let nSimulations = 1000
		let firstHand = PokerHand.Hand.make(holeCards.concat(communityCards))
		let requiredHandRank = parseInt(document.querySelector('#outsRequiredHandRankID').value)
		// handle 'Better Hand' special case
		if (requiredHandRank === -1) {
			requiredHandRank = firstHand.handRank + 1
		}
		console.log(`firstHand ${firstHand.minimalCards} name ${firstHand.handName} rank ${firstHand.handRank}`)
		console.log('requiredHandRank', requiredHandRank)


		let outCards = PokerHand.MonteCarlo.simulateOutsCount(holeCards, communityCards, requiredHandRank, nSimulations)
		console.log(`nOuts ${outCards.length} outCards ${outCards}`)
		document.querySelector('#nOutsID').innerHTML = outCards.length
		document.querySelector('#OutCardsID').innerHTML = outCards
	}

	////////////////////////////////////////////////////////////////////////
	//		Handle OddsIfAllIn
	////////////////////////////////////////////////////////////////////////

	setInterval(function () {
		computeOddsIfAllIn()
	}, 1000 / 30)


	function resetOddsIfAllIn() {
		bestOddsIfAllInValue = 0
		bestOddsIfAllInNRounds = 0
	}
	function displayOddsIfAllIn() {
		if (bestOddsIfAllInNRounds === 0) {
			document.querySelector('#oddsIfAllInValueID').innerHTML = '?'
			document.querySelector('#oddsIfAllInRoundsID').innerHTML = '?'
		} else {
			document.querySelector('#oddsIfAllInValueID').innerHTML = (bestOddsIfAllInValue * 100).toFixed(2) + '%'
			document.querySelector('#oddsIfAllInRoundsID').innerHTML = bestOddsIfAllInNRounds
		}
	}

	let bestOddsIfAllInValue = 0
	let bestOddsIfAllInNRounds = 0
	let bestOddsIfAllInStepRounds = 50
	let bestOddsIfAllInMaxNRounds = 10000
	function computeOddsIfAllIn() {
		if (bestOddsIfAllInNRounds >= bestOddsIfAllInMaxNRounds) return


		let holeCards = Array.from(document.querySelectorAll('#holeCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)
		let communityCards = Array.from(document.querySelectorAll('#communityCardsID .card'))
			.filter((domElement) => domElement.dataset.cardValue !== '  ')
			.map((domElement) => domElement.dataset.cardValue)
		let nbOtherPlayers = document.querySelector('#nOtherPlayersID').value

		if (holeCards.length < 2) {
			// console.log('not enougth holeCards')
			return
		}

		// console.time('simulateOddsIfAllIn')
		let oddsIfAllInValue = PokerHand.MonteCarlo.simulateOddsIfAllIn(bestOddsIfAllInStepRounds, holeCards, communityCards, nbOtherPlayers)
		// console.timeEnd('simulateOddsIfAllIn')
		// console.log('oddsIfAllInValue', oddsIfAllInValue)


		if (bestOddsIfAllInNRounds === 0) {
			console.log('init bestOddsIfAllInValue')
			bestOddsIfAllInValue = oddsIfAllInValue
			bestOddsIfAllInNRounds = bestOddsIfAllInStepRounds
		} else {
			bestOddsIfAllInValue = ((bestOddsIfAllInValue * bestOddsIfAllInNRounds) + (oddsIfAllInValue * bestOddsIfAllInStepRounds))
				/
				(bestOddsIfAllInNRounds + bestOddsIfAllInStepRounds)
			bestOddsIfAllInNRounds += bestOddsIfAllInStepRounds
		}

		displayOddsIfAllIn()
	}
</script>